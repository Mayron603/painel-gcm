<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel GCM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --background: #f8fafc; --card-bg: #ffffff; --text-primary: #0f172a; --text-secondary: #475569; --border-color: #e2e8f0; --sidebar-bg: #ffffff; --accent-color: #3b82f6; --accent-text: #ffffff; }
        html.dark { --background: #020617; --card-bg: #0f172a; --text-primary: #f8fafc; --text-secondary: #94a3b8; --border-color: #1e293b; --sidebar-bg: #0f172a; --accent-color: #60a5fa; --accent-text: #0f172a; }
        body { font-family: 'Readex Pro', sans-serif; background-color: var(--background); color: var(--text-primary); }
        .page-fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-link.active { background-color: var(--accent-color) !important; color: var(--accent-text) !important; font-weight: 600; }
        .modal-backdrop { background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(4px); }
        input, select { color: var(--text-primary); }
    </style>
</head>
<body class="min-h-screen antialiased">
    <div id="app-root"></div>
    <div id="modal-root"></div>
    <div id="toast-root" class="fixed top-5 right-5 z-[100] space-y-2"></div>

    <script>
        class GcmPanelApp {
            constructor(rootNode) {
                this.root = rootNode;
                this.modalRoot = document.getElementById('modal-root');
                this.toastRoot = document.getElementById('toast-root');
                this.state = { user: null, theme: 'dark', timers: {}, charts: {}, selectedReportUser: null };

                this.defineApi();
                this.defineTemplates();
                this.init();
            }

            async init() {
                this.state.theme = localStorage.getItem('theme') || 'dark';
                this.updateThemeClass();
                this.state.user = { name: 'Usuário', email: 'usuario@painel.com' };
                try {
                    await this.renderAppShell();
                    this.checkForAlerts();
                    this.state.timers.alerts = setInterval(() => this.checkForAlerts(), 5 * 60 * 1000); 
                } catch (error) {
                    console.error("Erro na inicialização:", error);
                    this.root.innerHTML = `<div class="p-4 text-red-500">Falha ao iniciar a aplicação. Verifique se a API está rodando.</div>`;
                }
            }
            
            async checkForAlerts() {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const res = await this.api.getAlerts();
                if(res.success && res.alerts.length > 0) {
                    alertContainer.innerHTML = this.templates.alertBanner(res.alerts);
                    alertContainer.querySelector('.close-alert-btn')?.addEventListener('click', () => alertContainer.innerHTML = '');
                } else {
                    alertContainer.innerHTML = '';
                }
            }

            async renderAppShell() {
                this.clearTimers();
                this.root.innerHTML = this.templates.appShell(this.state.user);
                this.setupCommonListeners();
                await this.navigateTo(window.location.hash.substring(1) || 'dashboard');
            }

            async navigateTo(page) {
                this.clearTimers();
                // Não reseta o usuário selecionado se a navegação for para a mesma página (ex: refresh com filtros)
                if (!window.location.hash.includes(page)) {
                    this.state.selectedReportUser = null; 
                }
                const contentContainer = this.root.querySelector('#page-content');
                if (!contentContainer) return;

                window.location.hash = page;
                this.root.querySelector('#page-title').textContent = page.charAt(0).toUpperCase() + page.slice(1);
                this.root.querySelectorAll('#main-nav a').forEach(a => a.classList.toggle('active', a.hash === `#${page}`));

                const pageRenderers = {
                    dashboard: this.renderDashboardPage,
                    ranking: this.renderRankingPage,
                    reports: this.renderReportsPage,
                    spreadsheet: this.renderSpreadsheetPage,
                    members: this.renderMembersPage,
                    settings: this.renderSettingsPage,
                };
                const renderer = pageRenderers[page] || this.renderNotFoundPage;

                await renderer.call(this, contentContainer);
            }
            
            async renderDashboardPage(container) {
                container.innerHTML = this.templates.loadingDashboard();
                const summary = await this.api.getDashboardSummary();
                if (summary && summary.success) {
                    container.innerHTML = this.templates.dashboardPage(summary, this.formatDuration);
                    this.renderChart('status', summary, '#status-chart');
                    this.renderChart('activity', summary.weeklyActivity, '#activity-chart');
                    this.renderChart('hourly', summary.hourlyActivity, '#hourly-activity-chart');
                    this.renderActivityFeed(summary.activityFeed);
                } else {
                    container.innerHTML = this.templates.errorPage('Falha ao carregar dados do dashboard.');
                }
            }
            
            formatDuration(ms, format = 'full') {
                if (isNaN(ms) || ms < 0) return 'N/A';
                if (format === 'hours') return `${(ms / 3600000).toFixed(2)}h`;

                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                let result = '';
                if (hours > 0) result += `${hours}h `;
                if (minutes > 0) result += `${minutes}m`;
                return result.trim() || '0m';
            }

            renderActivityFeed(feedItems) {
                const feedContainer = this.root.querySelector('#activity-feed');
                if (!feedContainer || !feedItems) return;
                feedContainer.innerHTML = feedItems.length > 0
                    ? feedItems.map(item => this.templates.activityFeedItem(item)).join('')
                    : '<p class="text-sm text-text-secondary text-center py-4">Nenhuma atividade recente.</p>';
            }
            
            async renderRankingPage(container) {
                container.innerHTML = this.templates.loadingDashboard();
                const [weeklyRes, monthlyRes] = await Promise.all([
                    this.api.getRanking('weekly'),
                    this.api.getRanking('monthly')
                ]);

                if (weeklyRes.success && monthlyRes.success) {
                    container.innerHTML = this.templates.rankingPage(weeklyRes.ranking, monthlyRes.ranking, this.formatDuration);
                } else {
                    container.innerHTML = this.templates.errorPage('Falha ao carregar rankings.');
                }
            }

            async renderReportsPage(container) {
                container.innerHTML = this.templates.loadingDashboard();
                
                if (this.state.selectedReportUser) {
                    await this.renderReportForUser(container, this.state.selectedReportUser);
                } else {
                    const usersResponse = await this.api.getUniqueUsers();
                    if (usersResponse.success) {
                        container.innerHTML = this.templates.reportUserListPage(usersResponse.users);
                        container.querySelectorAll('.user-report-link').forEach(link => {
                            link.addEventListener('click', (e) => {
                                e.preventDefault();
                                const userId = e.currentTarget.dataset.userid;
                                const username = e.currentTarget.dataset.username;
                                this.state.selectedReportUser = { userId, username };
                                this.renderReportsPage(container);
                            });
                        });
                    } else {
                        container.innerHTML = this.templates.errorPage('Falha ao carregar lista de usuários.');
                    }
                }
            }

            async renderReportForUser(container, user) {
                container.innerHTML = this.templates.reportsPage(user);
                this.root.querySelector('#filter-btn').addEventListener('click', () => this.renderReportTable(false));
                this.root.querySelector('#export-xlsx-btn').addEventListener('click', () => this.exportReport('xlsx'));
                this.root.querySelector('#export-pdf-btn').addEventListener('click', () => this.exportReport('pdf'));
                this.root.querySelector('#back-to-users-btn').addEventListener('click', () => {
                    this.state.selectedReportUser = null;
                    this.renderReportsPage(container);
                });
                await this.renderReportTable(false);
            }

            async renderMembersPage(container) {
                container.innerHTML = this.templates.loadingDashboard();
                const response = await this.api.getMembers();

                if (response && response.success) {
                    container.innerHTML = this.templates.membersPage(response.members);
                    const searchInput = this.root.querySelector('#member-search-input');
                    if (searchInput) {
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase();
                            this.root.querySelectorAll('.member-card').forEach(card => {
                                const username = card.dataset.username.toLowerCase();
                                card.style.display = username.includes(searchTerm) ? '' : 'none';
                            });
                        });
                    }
                } else {
                    container.innerHTML = this.templates.errorPage('Falha ao carregar lista de membros.');
                }
            }

            exportReport(format) {
                const filters = {
                    userId: this.state.selectedReportUser.userId,
                    status: this.root.querySelector('#status-filter-select').value,
                    startDate: this.root.querySelector('#start-date-filter').value,
                    endDate: this.root.querySelector('#end-date-filter').value,
                };
                const params = new URLSearchParams(Object.fromEntries(Object.entries(filters).filter(([_, v]) => v != null && v !== '')));
                params.append('format', format);
                window.open(`/api/registros/export?${params.toString()}`, '_blank');
            }

            // FUNÇÃO CORRIGIDA
            async renderReportTable(isSpreadsheet = false) {
                const tableId = isSpreadsheet ? '#spreadsheet-table-body' : '#reports-table-body';
                const tableBody = this.root.querySelector(tableId);
                if (!tableBody) return;

                const colspan = isSpreadsheet ? 6 : 5;
                tableBody.innerHTML = this.templates.loadingRow(colspan);
                
                const filters = isSpreadsheet ? {} : {
                    userId: this.state.selectedReportUser?.userId,
                    status: this.root.querySelector('#status-filter-select')?.value,
                    startDate: this.root.querySelector('#start-date-filter')?.value,
                    endDate: this.root.querySelector('#end-date-filter')?.value,
                };
                
                if (!isSpreadsheet && !filters.userId) {
                    tableBody.innerHTML = this.templates.emptyRow(colspan);
                    return;
                }

                const data = await this.api.getRegistros(filters);
                if (data && data.registros) {
                    let allPontos = data.registros.flatMap(reg => reg.pontos.map(p => ({...p, username: reg.username, userId: reg.userId })));
                    
                    allPontos.sort((a,b) => new Date(b.entrada) - new Date(a.entrada));
                    
                    if(isSpreadsheet) allPontos = allPontos.slice(0, 50);

                    const rowTemplate = isSpreadsheet ? this.templates.spreadsheetRow : this.templates.reportRow;

                    tableBody.innerHTML = allPontos.length > 0 ? allPontos.map(p => rowTemplate(p, this.formatDuration)).join('') : this.templates.emptyRow(colspan);
                    this.setupActionListeners(tableBody);
                } else {
                    tableBody.innerHTML = this.templates.emptyRow(colspan);
                }
            }

            async renderSpreadsheetPage(container) {
                container.innerHTML = this.templates.spreadsheetPage();
                const renderTable = () => this.renderReportTable(true);
                this.state.timers.spreadsheet = setInterval(renderTable, 30000);
                await renderTable();
            }

            renderSettingsPage(container) {
                container.innerHTML = this.templates.settingsPage();
            }

            renderNotFoundPage(container) {
                container.innerHTML = this.templates.notFoundPage();
            }

            setupCommonListeners() {
                this.root.querySelector('#theme-toggle')?.addEventListener('click', () => this.toggleTheme());
                window.onhashchange = () => this.navigateTo(window.location.hash.substring(1) || 'dashboard');
                this.updateThemeUI();
            }

            setupActionListeners(container) {
                container.querySelectorAll('.force-logout-btn').forEach(btn => btn.addEventListener('click', async e => {
                    const pontoId = e.currentTarget.dataset.id;
                    const result = await this.api.forceLogout(pontoId);
                    this.showToast(result.message, result.success ? 'success' : 'error');
                    if(result.success) this.navigateTo(window.location.hash.substring(1));
                }));
                container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => {
                    const ponto = JSON.parse(e.currentTarget.dataset.ponto);
                    this.renderEditModal(ponto);
                }));
                container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => {
                    this.renderDeleteModal(e.currentTarget.dataset.id);
                }));
            }

            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.state.theme);
                this.updateThemeUI();
            }

            updateThemeClass() { document.documentElement.className = this.state.theme; }
            updateThemeUI() {
                this.updateThemeClass();
                const themeIcon = this.root.querySelector('#theme-toggle');
                if(themeIcon) themeIcon.innerHTML = `<i class="fas fa-${this.state.theme === 'light' ? 'moon' : 'sun'} text-xl"></i>`;
            }

            clearTimers() {
                Object.values(this.state.timers).forEach(timer => clearInterval(timer));
                this.state.timers = {};
            }

            renderChart(type, data, selector) {
                const ctx = this.root.querySelector(selector)?.getContext('2d');
                if (!ctx) return;
                if (this.state.charts[type]) this.state.charts[type].destroy();
                const chartColors = { text: this.state.theme === 'dark' ? '#94a3b8' : '#475569', grid: this.state.theme === 'dark' ? '#1e293b' : '#e2e8f0', cardBg: this.state.theme === 'dark' ? '#0f172a' : '#ffffff' };
                
                if (type === 'hourly') {
                    this.state.charts.hourly = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`),
                            datasets: [{
                                label: 'Registros por Hora',
                                data: data,
                                backgroundColor: 'rgba(96, 165, 250, 0.5)',
                                borderColor: '#60a5fa',
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: chartColors.text, stepSize: 1 }, grid: { color: chartColors.grid } }, x: { ticks: { color: chartColors.text }, grid: { display: false } } }, plugins: { legend: { display: false } } }
                    });
                } else if (type === 'status') {
                    this.state.charts.status = new Chart(ctx, { type: 'doughnut', data: { labels: ['Fechados Hoje', 'Pendentes'], datasets: [{ data: [data.closedToday, data.pendingRegisters], backgroundColor: ['#22c55e', '#f59e0b'], borderColor: chartColors.cardBg, borderWidth: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: chartColors.text } } } } });
                } else if (type === 'activity') {
                    const labels = [...Array(7)].map((_, i) => new Date(new Date().setDate(new Date().getDate() - i)).toISOString().slice(0, 10)).reverse();
                    this.state.charts.activity = new Chart(ctx, { type: 'line', data: { labels: labels.map(l => new Date(l).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})), datasets: [{ label: 'Registros', data: labels.map(l => data[l] || 0), backgroundColor: 'rgba(59, 130, 246, 0.1)', borderColor: '#3b82f6', borderWidth: 2, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: chartColors.text }, grid: { color: chartColors.grid } }, x: { ticks: { color: chartColors.text }, grid: { display: false } } }, plugins: { legend: { display: false } } } });
                }
            }

            renderEditModal(ponto) {
                this.modalRoot.innerHTML = this.templates.editModal(ponto);
                this.modalRoot.querySelector('.modal-close-btn').addEventListener('click', () => this.modalRoot.innerHTML = '');
                this.modalRoot.querySelector('#edit-form').addEventListener('submit', async e => {
                    e.preventDefault();
                    const form = e.currentTarget;
                    const result = await this.api.updateRegistro(ponto._id, { entrada: form.entrada.value, saida: form.saida.value });
                    this.showToast(result.message, result.success ? 'success' : 'error');
                    if (result.success) {
                        this.modalRoot.innerHTML = '';
                        this.navigateTo(window.location.hash.substring(1));
                    }
                });
            }
            
            renderDeleteModal(pontoId) {
                this.modalRoot.innerHTML = this.templates.deleteModal();
                this.modalRoot.querySelector('.modal-close-btn').addEventListener('click', () => this.modalRoot.innerHTML = '');
                this.modalRoot.querySelector('#confirm-delete-btn').addEventListener('click', async () => {
                    const result = await this.api.deleteRegistro(pontoId);
                    this.showToast(result.message, result.success ? 'success' : 'error');
                    this.modalRoot.innerHTML = '';
                    if (result.success) this.navigateTo(window.location.hash.substring(1));
                });
            }

            showToast(message, type = 'info') {
                const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
                const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                const toast = document.createElement('div');
                toast.className = `flex items-center w-full max-w-xs p-4 text-white ${colors[type]} rounded-lg shadow-lg page-fade-in`;
                toast.innerHTML = `<div class="text-xl"><i class="fas ${icons[type]}"></i></div><div class="ml-3 text-sm font-medium">${message}</div>`;
                this.toastRoot.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
            }

            isColorDark(hexColor) {
                if (!hexColor || hexColor.length < 4) return false;
                let color = (hexColor.charAt(0) === '#') ? hexColor.substring(1, 7) : hexColor;
                if (color.length === 3) {
                    color = color[0] + color[0] + color[1] + color[1] + color[2] + color[2];
                }
                const r = parseInt(color.substring(0, 2), 16);
                const g = parseInt(color.substring(2, 4), 16);
                const b = parseInt(color.substring(4, 6), 16);
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance < 0.5;
            }

            defineApi() {
                this.api = {
                    fetch: async (endpoint, options = {}) => { try { const res = await fetch(`/api${endpoint}`, options); return res.json(); } catch (err) { return { success: false, message: 'Erro de rede.' }; } },
                    getDashboardSummary: () => this.api.fetch('/dashboard/summary'),
                    getRanking: (period) => this.api.fetch(`/ranking?period=${period}`),
                    getRegistros: (filters = {}) => { const params = new URLSearchParams(Object.fromEntries(Object.entries(filters).filter(([_, v]) => v != null && v !== ''))); return this.api.fetch(`/registros?${params}`); },
                    getUniqueUsers: () => this.api.fetch('/unique-users'),
                    getAlerts: () => this.api.fetch('/alerts'),
                    getMembers: () => this.api.fetch('/members'),
                    forceLogout: (pontoId) => this.api.fetch(`/registros/force-logout/${pontoId}`, { method: 'POST' }),
                    updateRegistro: (pontoId, data) => this.api.fetch(`/registros/${pontoId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }),
                    deleteRegistro: (pontoId) => this.api.fetch(`/registros/${pontoId}`, { method: 'DELETE' }),
                };
            }

defineTemplates() {
    this.templates = {
        alertBanner: (alerts) => `<div class="bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 m-6 rounded-lg shadow-lg flex justify-between items-center page-fade-in" role="alert"><p><strong class="font-bold">Atenção:</strong> Existem ${alerts.length} ponto(s) aberto(s) há mais de 12 horas.</p><button class="close-alert-btn font-bold text-2xl leading-none px-2">&times;</button></div>`,
        
        appShell: (user) => `<div class="flex h-screen"><aside class="sidebar w-64 flex-shrink-0 flex flex-col border-r transition-all" style="background-color: var(--sidebar-bg); border-color: var(--border-color);"><div class="h-16 flex items-center justify-center px-4 border-b border-inherit"><h1 class="text-xl font-bold text-blue-500 flex items-center gap-2"><i class="fas fa-shield-alt"></i><span>PAINEL GCM</span></h1></div><nav class="flex-1 px-4 py-6 space-y-1.5" id="main-nav"><a href="#dashboard" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-home w-6 mr-3 text-center"></i>Dashboard</a><a href="#ranking" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-trophy w-6 mr-3 text-center"></i>Ranking</a><a href="#reports" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-file-invoice w-6 mr-3 text-center"></i>Relatórios</a><a href="#spreadsheet" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-table w-6 mr-3 text-center"></i>Planilha</a><a href="#members" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-users w-6 mr-3 text-center"></i>Membros</a></nav><div class="p-4 border-t border-inherit"><a href="#settings" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold transition-colors mb-2"><i class="fas fa-cog w-6 mr-3 text-center"></i>Configurações</a></div></aside><main class="flex-1 flex flex-col overflow-hidden"><header class="h-16 flex items-center justify-between px-6 border-b border-inherit flex-shrink-0 bg-[var(--card-bg)]/80 backdrop-blur-sm"><h2 id="page-title" class="text-2xl font-bold"></h2><div class="flex items-center space-x-4"><button id="theme-toggle" class="text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full w-10 h-10 flex items-center justify-center transition-colors"></button><div class="text-right"><div class="font-semibold text-sm">${user.name}</div><div class="text-xs text-text-secondary">${user.email}</div></div></div></header><div id="alert-container"></div><div id="page-content" class="flex-1 overflow-y-auto p-6 page-fade-in"></div></main></div>`,
        
        loadingDashboard: () => `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${this.templates.summaryCard("Carregando...", "...", "fa-spinner fa-spin")}${this.templates.summaryCard("...", "...", "fa-spinner fa-spin")}${this.templates.summaryCard("...", "...", "fa-spinner fa-spin")}${this.templates.summaryCard("...", "...", "fa-spinner fa-spin")}</div><div class="text-center p-16 text-text-secondary"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`,
        dashboardPage: (s, formatDuration) => `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${this.templates.summaryCard("Total de Agentes", s.totalAgents, "fa-users")}${this.templates.summaryCard("Pontos Pendentes", s.pendingRegisters, "fa-clock", "text-amber-500")}${this.templates.summaryCard("Fechados Hoje", s.closedToday, "fa-check-circle", "text-green-500")}${this.templates.summaryCard("Horas do Dia", formatDuration(s.hoursToday * 3600000), "fa-stopwatch", "text-blue-500")}</div><div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 card rounded-xl shadow-lg p-6 border-0" style="background-color: var(--card-bg);"><h3 class="font-semibold mb-4 text-lg">Atividade da Semana</h3><div class="h-80"><canvas id="activity-chart"></canvas></div></div><div class="card rounded-xl shadow-lg p-6 border-0" style="background-color: var(--card-bg);"><h3 class="font-semibold mb-4 text-lg">Atividade Recente</h3><ul id="activity-feed" class="space-y-4"></ul></div></div><div class="mt-6 card rounded-xl shadow-lg p-6 border-0" style="background-color: var(--card-bg);"><h3 class="font-semibold mb-4 text-lg">Registros por Hora (Hoje)</h3><div class="h-80"><canvas id="hourly-activity-chart"></canvas></div></div>`,
        activityFeedItem: (item) => `<li class="flex items-center text-sm"><i class="fas ${item.ponto.saida ? 'fa-sign-out-alt text-red-500' : 'fa-sign-in-alt text-green-500'} w-4 mr-3 flex-shrink-0"></i><div class="flex-grow"><span class="font-semibold">${item.username}</span> ${item.ponto.saida ? 'encerrou o ponto' : 'iniciou um ponto'}.</div><span class="ml-auto text-xs text-text-secondary flex-shrink-0">${new Date(item.ponto.saida || item.ponto.entrada).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span></li>`,
        summaryCard: (t, v, i, c = '') => `<div class="card rounded-xl p-5 shadow-lg border-0" style="background-color: var(--card-bg);"><div class="flex items-center"><div class="p-3 rounded-full bg-blue-500/10 text-blue-500 mr-4"><i class="fas ${i}"></i></div><div><h4 class="text-sm font-medium text-text-secondary">${t}</h4><p class="text-2xl font-bold mt-1 ${c}">${v}</p></div></div></div>`,
        
        reportsPage: (user) => `<div class="card rounded-xl shadow-lg border-0" style="background-color: var(--card-bg);"><div class="p-6 border-b border-inherit flex justify-between items-center flex-wrap gap-4"><div class="flex items-center gap-4"><button id="back-to-users-btn" class="text-text-secondary hover:text-blue-500 w-8 h-8 rounded-lg hover:bg-slate-500/10" title="Voltar para a lista"><i class="fas fa-arrow-left"></i></button><h3 class="text-xl font-bold">Relatório de: ${user.username}</h3></div><div class="flex gap-2"><button id="export-xlsx-btn" class="bg-green-600 text-white font-semibold rounded-lg h-9 px-4 text-sm flex items-center gap-2 hover:bg-green-700 transition-colors"><i class="fas fa-file-excel"></i>Excel</button><button id="export-pdf-btn" class="bg-red-600 text-white font-semibold rounded-lg h-9 px-4 text-sm flex items-center gap-2 hover:bg-red-700 transition-colors"><i class="fas fa-file-pdf"></i>PDF</button></div></div><div class="p-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><select id="status-filter-select" class="md:col-span-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 border-transparent rounded-lg"><option value="">Todos Status</option><option value="completed">Completo</option><option value="pending">Pendente</option></select><input type="date" id="start-date-filter" class="md:col-span-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 border-transparent rounded-lg"><input type="date" id="end-date-filter" class="md:col-span-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 border-transparent rounded-lg"><button id="filter-btn" class="md-col-span-1 bg-blue-600 text-white font-semibold rounded-lg h-10 px-4 hover:bg-blue-700 transition-colors">Filtrar</button></div><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="text-xs text-text-secondary uppercase bg-slate-50 dark:bg-slate-800/50"><tr><th class="px-6 py-3 text-left font-semibold">Entrada</th><th class="px-6 py-3 text-left font-semibold">Saída</th><th class="px-6 py-3 text-left font-semibold">Duração</th><th class="px-6 py-3 text-center font-semibold">Status</th><th class="px-6 py-3 text-center font-semibold">Ações</th></tr></thead><tbody id="reports-table-body" class="divide-y divide-inherit"></tbody></table></div></div>`,
        
        reportUserListPage: (users) => `<div class="card rounded-xl shadow-lg border-0" style="background-color: var(--card-bg);"><div class="p-6 border-b border-inherit"><h3 class="text-xl font-bold">Relatórios</h3><p class="text-sm text-text-secondary">Selecione um agente para ver seus registros de ponto.</p></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-6">${users.map(u => `<a href="#" class="user-report-link card p-4 flex items-center gap-3 rounded-lg hover:bg-blue-500/10 transition-colors" data-userid="${u.userId}" data-username="${u.username}"><i class="fas fa-user-circle text-2xl text-text-secondary"></i><span class="font-semibold">${u.username}</span></a>`).join('')}</div></div>`,

        reportRow: (p, formatDuration) => { const iC = p.entrada && p.saida, d = iC ? (new Date(p.saida) - new Date(p.entrada)) : 0; return `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60"><td class="p-4 px-6 text-text-secondary">${new Date(p.entrada).toLocaleString('pt-BR')}</td><td class="p-4 px-6 text-text-secondary">${p.saida ? new Date(p.saida).toLocaleString('pt-BR') : '<span class="italic text-slate-500">Em serviço...</span>'}</td><td class="p-4 px-6 font-semibold">${iC ? formatDuration(d) : '---'}</td><td class="p-4 px-6 text-center"><span class="px-2.5 py-0.5 text-xs font-semibold rounded-full ${iC ? 'bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300' : 'bg-amber-100 text-amber-800 dark:bg-amber-500/20 dark:text-amber-300'}">${iC ? 'Completo' : 'Pendente'}</span></td><td class="p-4 px-6 text-center"><div class="flex justify-center gap-2">${!iC ? `<button data-id="${p._id}" class="force-logout-btn text-text-secondary hover:text-amber-500 w-8 h-8 rounded-lg hover:bg-slate-500/10" title="Forçar Saída"><i class="fas fa-clock"></i></button>` : ''}<button data-ponto='${JSON.stringify(p)}' class="edit-btn text-text-secondary hover:text-blue-500 w-8 h-8 rounded-lg hover:bg-slate-500/10" title="Editar"><i class="fas fa-pencil-alt"></i></button><button data-id="${p._id}" class="delete-btn text-text-secondary hover:text-red-500 w-8 h-8 rounded-lg hover:bg-slate-500/10" title="Excluir"><i class="fas fa-trash-alt"></i></button></div></td></tr>` },
        
        // NOVO TEMPLATE PARA A LINHA DA PLANILHA
        spreadsheetRow: (p, formatDuration) => { const iC = p.entrada && p.saida, d = iC ? (new Date(p.saida) - new Date(p.entrada)) : 0; return `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60"><td class="p-4 px-6 font-medium">${p.username}</td><td class="p-4 px-6 text-text-secondary">${new Date(p.entrada).toLocaleString('pt-BR')}</td><td class="p-4 px-6 text-text-secondary">${p.saida ? new Date(p.saida).toLocaleString('pt-BR') : '<span class="italic text-slate-500">Em serviço...</span>'}</td><td class="p-4 px-6 font-semibold">${iC ? formatDuration(d) : '---'}</td><td class="p-4 px-6 text-center"><span class="px-2.5 py-0.5 text-xs font-semibold rounded-full ${iC ? 'bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300' : 'bg-amber-100 text-amber-800 dark:bg-amber-500/20 dark:text-amber-300'}">${iC ? 'Completo' : 'Pendente'}</span></td><td class="p-4 px-6 text-center"><div class="flex justify-center gap-2">${!iC ? `<button data-id="${p._id}" class="force-logout-btn text-text-secondary hover:text-amber-500 w-8 h-8 rounded-lg hover:bg-slate-500/10" title="Forçar Saída"><i class="fas fa-clock"></i></button>` : ''}<button data-ponto='${JSON.stringify(p)}' class="edit-btn text-text-secondary hover:text-blue-500 w-8 h-8 rounded-lg hover:bg-slate-500/10" title="Editar"><i class="fas fa-pencil-alt"></i></button><button data-id="${p._id}" class="delete-btn text-text-secondary hover:text-red-500 w-8 h-8 rounded-lg hover:bg-slate-500/10" title="Excluir"><i class="fas fa-trash-alt"></i></button></div></td></tr>` },
        
        spreadsheetPage: () => `<div class="card rounded-xl shadow-lg border-0" style="background-color: var(--card-bg);"><div class="p-6 border-b border-inherit flex justify-between items-center"><div><h3 class="text-xl font-bold">Planilha ao Vivo</h3><p class="text-sm text-text-secondary">Atualiza a cada 30 segundos.</p></div><i class="fas fa-wifi text-green-500"></i></div><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="text-xs text-text-secondary uppercase bg-slate-50 dark:bg-slate-800/50"><tr><th class="px-6 py-3 text-left font-semibold">Usuário</th><th class="px-6 py-3 text-left font-semibold">Entrada</th><th class="px-6 py-3 text-left font-semibold">Saída</th><th class="px-6 py-3 text-left font-semibold">Duração</th><th class="px-6 py-3 text-center font-semibold">Status</th><th class="px-6 py-3 text-center font-semibold">Ações</th></tr></thead><tbody id="spreadsheet-table-body" class="divide-y divide-inherit"></tbody></table></div></div>`,
        settingsPage: () => `<div class="card rounded-xl p-6 shadow-lg border-0 max-w-2xl mx-auto" style="background-color: var(--card-bg);"><h3 class="text-xl font-bold mb-1">Configurações</h3><p class="text-sm text-text-secondary mb-6">Ajustes gerais do sistema.</p><div class="text-center p-8 border-2 border-dashed border-border-color rounded-lg text-text-secondary">Página de Configurações em construção.</div></div>`,
        errorPage: (message) => `<div class="text-center p-16"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><h1 class="text-2xl font-bold">Ocorreu um Erro</h1><p class="text-text-secondary">${message}</p></div>`,
        loadingRow: c => `<tr><td colspan="${c}" class="text-center p-8 text-text-secondary"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando...</td></tr>`,
        emptyRow: c => `<tr><td colspan="${c}" class="text-center p-8 text-text-secondary"><i class="fas fa-inbox mr-2"></i>Nenhum registro encontrado.</td></tr>`,
        notFoundPage: () => `<div class="text-center p-16"><h1 class="text-4xl font-bold">404</h1><p class="text-text-secondary">Página não encontrada.</p></div>`,
        editModal: p => `<div class="fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4"><div class="card rounded-2xl shadow-2xl w-full max-w-md border-0 page-fade-in" style="background-color: var(--card-bg);"><form id="edit-form" class="p-6"><h3 class="text-xl font-bold mb-4">Editar Registro</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Entrada</label><input type="datetime-local" name="entrada" class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg" value="${new Date(new Date(p.entrada).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16)}" required></div><div><label class="block text-sm font-medium mb-1">Saída</label><input type="datetime-local" name="saida" class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg" value="${p.saida ? new Date(new Date(p.saida).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : ''}" required></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" class="modal-close-btn px-4 py-2 rounded-lg hover:bg-slate-500/10">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-semibold rounded-lg px-5 py-2 hover:bg-blue-700 transition-all">Salvar</button></div></form></div></div>`,
        deleteModal: () => `<div class="fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4"><div class="card rounded-2xl shadow-2xl w-full max-w-sm border-0 p-6 text-center page-fade-in" style="background-color: var(--card-bg);"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><h3 class="text-xl font-bold mb-2">Excluir Registro?</h3><p class="text-text-secondary mb-6">Esta ação é irreversível.</p><div class="flex justify-center gap-3"><button class="modal-close-btn px-6 py-2 rounded-lg hover:bg-slate-500/10">Cancelar</button><button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold rounded-lg px-6 py-2 hover:bg-red-700 transition-all">Excluir</button></div></div></div>`,
        
        rankingPage: (weekly, monthly, formatDuration) => `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                ${this.templates.rankingCard('Ranking Semanal', 'fa-calendar-week', weekly, formatDuration)}
                ${this.templates.rankingCard('Ranking Mensal', 'fa-calendar-alt', monthly, formatDuration)}
            </div>`,
        rankingCard: (title, icon, rankingData, formatDuration) => `
            <div class="card rounded-xl shadow-lg border-0" style="background-color: var(--card-bg);">
                <div class="p-6 border-b border-inherit">
                    <h3 class="text-xl font-bold flex items-center gap-3"><i class="fas ${icon}"></i>${title}</h3>
                </div>
                <ul class="divide-y divide-inherit">
                    ${rankingData.length > 0 ? rankingData.map((item, index) => this.templates.rankingItem(item, index, formatDuration)).join('') : '<li class="p-6 text-center text-text-secondary">Nenhum dado para exibir.</li>'}
                </ul>
            </div>`,
        rankingItem: (item, index, formatDuration) => {
            const colors = ['text-amber-400', 'text-slate-400', 'text-amber-600'];
            const icon = index < 3 ? `<i class="fas fa-trophy ${colors[index]}"></i>` : `<span class="font-semibold text-text-secondary">${index + 1}</span>`;
            return `
                <li class="p-4 flex items-center justify-between hover:bg-slate-500/10">
                    <div class="flex items-center gap-4">
                        <div class="w-6 text-center text-lg">${icon}</div>
                        <span class="font-semibold">${item.username}</span>
                    </div>
                    <span class="font-bold text-blue-500">${formatDuration(item.totalDuration)}</span>
                </li>`;
        },

        membersPage: (members) => `
            <div class="card rounded-xl shadow-lg border-0" style="background-color: var(--card-bg);">
                <div class="p-6 border-b border-inherit flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h3 class="text-xl font-bold">Membros do Discord</h3>
                        <p class="text-sm text-text-secondary">Lista de membros e seus cargos sincronizados.</p>
                    </div>
                    <div class="relative w-full md:w-auto">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary"></i>
                        <input type="text" id="member-search-input" placeholder="Buscar membro..." class="w-full md:w-64 pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-800 border-transparent rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
                    ${members && members.length > 0 ? members.map(m => this.templates.memberCard(m)).join('') : '<p class="col-span-full text-center p-8 text-text-secondary"><i class="fas fa-inbox mr-2"></i>Nenhum membro encontrado. Execute /sync-members no bot.</p>'}
                </div>
            </div>`,
        memberCard: (member) => `
            <div class="member-card flex flex-col rounded-lg border p-4 transition-all hover:shadow-lg hover:border-blue-500/50" style="border-color: var(--border-color); background-color: var(--card-bg);" data-username="${member.username}">
                <div class="flex items-center mb-4">
                    <img src="${member.avatarUrl || 'https://cdn.discordapp.com/embed/avatars/0.png'}" alt="Avatar" class="w-12 h-12 rounded-full mr-4">
                    <span class="font-bold text-lg truncate">${member.username}</span>
                </div>
                <div>
                    <h4 class="font-semibold text-sm mb-2 text-text-secondary">Cargos (${member.roles.length}):</h4>
                    <div class="flex flex-wrap gap-2">
                        ${member.roles.length > 0 ? member.roles.map(role => `
                            <span class="text-xs font-semibold px-2 py-1 rounded-full flex items-center" style="background-color: ${role.color || '#99aab5'}; color: ${this.isColorDark(role.color || '#99aab5') ? '#FFF' : '#000'};">
                                <i class="fas fa-circle fa-xs mr-1.5" style="opacity: 0.5;"></i>
                                ${role.name}
                            </span>
                        `).join('') : '<span class="text-xs text-text-secondary italic">Nenhum cargo.</span>'}
                    </div>
                </div>
            </div>`,
    };
}
        }

        new GcmPanelApp(document.getElementById('app-root'));
    </script>
</body>
</html>