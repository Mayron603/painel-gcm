<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel GCM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --background: #f8fafc; --card-bg: #ffffff; --text-primary: #0f172a; --text-secondary: #475569; --border-color: #e2e8f0; --sidebar-bg: #ffffff; --accent-color: #3b82f6; --accent-text: #ffffff; }
        html.dark { --background: #020617; --card-bg: #0f172a; --text-primary: #f8fafc; --text-secondary: #94a3b8; --border-color: #1e293b; --sidebar-bg: #0f172a; --accent-color: #60a5fa; --accent-text: #0f172a; }
        body { font-family: 'Readex Pro', sans-serif; background-color: var(--background); color: var(--text-primary); }
        .page-fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-link.active { background-color: var(--accent-color) !important; color: var(--accent-text) !important; font-weight: 600; }
        .modal-backdrop { background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(4px); }
        input, select { color: var(--text-primary); }
    </style>
</head>
<body class="min-h-screen antialiased">
    <div id="app-root"></div>
    <div id="modal-root"></div>
    <div id="toast-root" class="fixed top-5 right-5 z-[100] space-y-2"></div>

    <script>
        class GcmPanelApp {
            constructor(rootNode) {
                this.root = rootNode;
                this.modalRoot = document.getElementById('modal-root');
                this.toastRoot = document.getElementById('toast-root');
                this.state = { user: { name: 'Admin', email: 'Acesso Direto' }, theme: 'dark', timers: {}, charts: {} };
                this.defineApi();
                this.defineTemplates();
                this.init();
            }

            async init() {
                this.state.theme = localStorage.getItem('theme') || 'dark';
                this.updateThemeClass();
                await this.renderAppShell();
            }

            async renderAppShell() {
                this.clearTimers();
                this.root.innerHTML = this.templates.appShell(this.state.user);
                this.setupCommonListeners();
                await this.navigateTo(window.location.hash.substring(1) || 'dashboard');
            }

            async navigateTo(page) {
                this.clearTimers();
                const contentContainer = this.root.querySelector('#page-content');
                if (!contentContainer) return;
                window.location.hash = page;
                this.root.querySelector('#page-title').textContent = page.charAt(0).toUpperCase() + page.slice(1);
                this.root.querySelectorAll('#main-nav a').forEach(a => a.classList.toggle('active', a.hash === `#${page}`));
                const pageRenderers = {
                    dashboard: this.renderDashboardPage,
                    reports: this.renderReportsPage,
                    spreadsheet: this.renderSpreadsheetPage,
                    settings: this.renderSettingsPage,
                };
                const renderer = pageRenderers[page] || this.renderNotFoundPage;
                await renderer.call(this, contentContainer);
            }

            async renderDashboardPage(container) {
                container.innerHTML = this.templates.loadingDashboard();
                try {
                    const summary = await this.api.getDashboardSummary();
                    if (summary && summary.success) {
                        container.innerHTML = this.templates.dashboardPage(summary);
                        this.renderChart('activity', summary.weeklyActivity, '#activity-chart');
                        this.renderChart('hourly', summary.hourlyActivity, '#hourly-activity-chart');
                        this.renderActivityFeed(summary.activityFeed);
                    } else {
                        container.innerHTML = this.templates.errorPage(summary.message || 'Falha ao carregar dados.');
                    }
                } catch (error) {
                    container.innerHTML = this.templates.errorPage(error.message);
                }
            }

            renderActivityFeed(feedItems) {
                const feedContainer = this.root.querySelector('#activity-feed');
                if (!feedContainer || !feedItems) return;
                feedContainer.innerHTML = feedItems.length > 0
                    ? feedItems.map(item => this.templates.activityFeedItem(item)).join('')
                    : '<p class="text-sm text-text-secondary text-center py-4">Nenhuma atividade recente.</p>';
            }

            async renderReportsPage(container) {
                const usersResponse = await this.api.getUniqueUsers();
                const users = usersResponse.success ? usersResponse.users : [];
                container.innerHTML = this.templates.reportsPage(users);
                this.root.querySelector('#filter-btn').addEventListener('click', () => this.renderReportTable());
                this.root.querySelector('#export-xlsx-btn').addEventListener('click', () => this.exportReport('xlsx'));
                this.root.querySelector('#export-pdf-btn').addEventListener('click', () => this.exportReport('pdf'));
                await this.renderReportTable();
            }

            exportReport(format) {
                const filters = {
                    userId: this.root.querySelector('#user-filter-select').value,
                    status: this.root.querySelector('#status-filter-select').value,
                    startDate: this.root.querySelector('#start-date-filter').value,
                    endDate: this.root.querySelector('#end-date-filter').value,
                };
                const params = new URLSearchParams(Object.fromEntries(Object.entries(filters).filter(([_, v]) => v != null && v !== '')));
                params.append('format', format);
                window.open(`/api/registros/export?${params.toString()}`, '_blank');
            }

            async renderReportTable(isSpreadsheet = false) {
                const tableId = isSpreadsheet ? '#spreadsheet-table-body' : '#reports-table-body';
                const tableBody = this.root.querySelector(tableId);
                if (!tableBody) return;
                tableBody.innerHTML = this.templates.loadingRow(6);
                const filters = isSpreadsheet ? {} : {
                    userId: this.root.querySelector('#user-filter-select')?.value,
                    status: this.root.querySelector('#status-filter-select')?.value,
                    startDate: this.root.querySelector('#start-date-filter')?.value,
                    endDate: this.root.querySelector('#end-date-filter')?.value,
                };
                const data = await this.api.getRegistros(filters);
                if (data && data.success && data.registros) {
                    let allPontos = data.registros.flatMap(reg => reg.pontos.map(p => ({...p, username: reg.username, userId: reg.userId })));
                    allPontos.sort((a,b) => new Date(b.entrada) - new Date(a.entrada));
                    if (isSpreadsheet) {
                        allPontos = allPontos.slice(0, 50);
                    }
                    tableBody.innerHTML = allPontos.length > 0 ? allPontos.map(p => this.templates.reportRow(p)).join('') : this.templates.emptyRow(6);
                    this.setupActionListeners(tableBody);
                } else {
                    tableBody.innerHTML = this.templates.errorRow(6);
                }
            }

            async renderSpreadsheetPage(container) {
                container.innerHTML = this.templates.spreadsheetPage();
                const renderTable = () => this.renderReportTable(true);
                this.state.timers.spreadsheet = setInterval(renderTable, 30000);
                await renderTable();
            }

            renderSettingsPage(container) {
                container.innerHTML = this.templates.settingsPage();
            }

            renderNotFoundPage(container) {
                container.innerHTML = this.templates.notFoundPage();
            }

            setupCommonListeners() {
                this.root.querySelector('#theme-toggle')?.addEventListener('click', () => this.toggleTheme());
                window.onhashchange = () => this.navigateTo(window.location.hash.substring(1) || 'dashboard');
                this.updateThemeUI();
            }

            setupActionListeners(container) {
                container.querySelectorAll('.force-logout-btn').forEach(btn => btn.addEventListener('click', async (e) => this.handleAction(e, 'forceLogout')));
                container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => this.renderEditModal(JSON.parse(e.currentTarget.dataset.ponto))));
                container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => this.renderDeleteModal(e.currentTarget.dataset.id)));
            }
            
            async handleAction(event, action, data = null) {
                const pontoId = event.currentTarget.dataset.id;
                const result = await this.api[action](pontoId, data);
                this.showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    this.navigateTo(window.location.hash.substring(1));
                }
            }

            renderEditModal(ponto) { /* ... */ }
            renderDeleteModal(pontoId) { /* ... */ }

            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.state.theme);
                this.updateThemeUI();
            }

            updateThemeClass() { document.documentElement.className = this.state.theme; }
            updateThemeUI() {
                this.updateThemeClass();
                const themeIcon = this.root.querySelector('#theme-toggle');
                if(themeIcon) themeIcon.innerHTML = `<i class="fas fa-${this.state.theme === 'light' ? 'moon' : 'sun'} text-xl"></i>`;
            }

            clearTimers() {
                Object.values(this.state.timers).forEach(timer => clearInterval(timer));
                this.state.timers = {};
            }

            renderChart(type, data, selector) {
                const ctx = this.root.querySelector(selector)?.getContext('2d');
                if (!ctx || !data) return;
                if (this.state.charts[type]) this.state.charts[type].destroy();
                const chartColors = { text: this.state.theme === 'dark' ? '#94a3b8' : '#475569', grid: this.state.theme === 'dark' ? '#1e293b' : '#e2e8f0' };

                if (type === 'hourly') {
                    this.state.charts.hourly = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`),
                            datasets: [{ label: 'Registros por Hora', data: data, backgroundColor: 'rgba(96, 165, 250, 0.5)', borderColor: '#60a5fa', borderWidth: 1 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: chartColors.text, stepSize: 1 }, grid: { color: chartColors.grid } }, x: { ticks: { color: chartColors.text }, grid: { display: false } } }, plugins: { legend: { display: false } } }
                    });
                } else if (type === 'activity') {
                    const labels = [...Array(7)].map((_, i) => new Date(new Date().setDate(new Date().getDate() - i)).toISOString().slice(0, 10)).reverse();
                    const chartData = labels.map(label => data[label] || 0);
                    this.state.charts.activity = new Chart(ctx, { type: 'line', data: { labels: labels.map(l => new Date(l).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})), datasets: [{ label: 'Registros', data: chartData, backgroundColor: 'rgba(59, 130, 246, 0.1)', borderColor: '#3b82f6', borderWidth: 2, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: chartColors.text }, grid: { color: chartColors.grid } }, x: { ticks: { color: chartColors.text }, grid: { display: false } } }, plugins: { legend: { display: false } } } });
                }
            }

            showToast(message, type = 'info') {
                const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
                const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                const toast = document.createElement('div');
                toast.className = `flex items-center w-full max-w-xs p-4 text-white ${colors[type]} rounded-lg shadow-lg page-fade-in`;
                toast.innerHTML = `<div class="text-xl"><i class="fas ${icons[type]}"></i></div><div class="ml-3 text-sm font-medium">${message}</div>`;
                this.toastRoot.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
            }

            defineApi() {
                this.api = {
                    fetch: async (endpoint, options = {}) => {
                        try {
                            const res = await fetch(`/api${endpoint}`, options);
                            if (!res.ok) {
                                const errorText = await res.text();
                                throw new Error(`Erro na API: ${res.status} - ${errorText}`);
                            }
                            return res.json();
                        } catch (err) {
                            console.error('Erro de fetch:', err);
                            throw err;
                        }
                    },
                    getDashboardSummary: () => this.api.fetch('/dashboard/summary'),
                    getRegistros: (filters = {}) => { const params = new URLSearchParams(Object.fromEntries(Object.entries(filters).filter(([_, v]) => v != null && v !== ''))); return this.api.fetch(`/registros?${params}`); },
                    getUniqueUsers: () => this.api.fetch('/unique-users'),
                    forceLogout: (pontoId) => this.api.fetch(`/registros/force-logout/${pontoId}`, { method: 'POST' }),
                    updateRegistro: (pontoId, data) => this.api.fetch(`/registros/${pontoId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }),
                    deleteRegistro: (pontoId) => this.api.fetch(`/registros/${pontoId}`, { method: 'DELETE' }),
                };
            }

            defineTemplates() {
                this.templates = {
                    appShell: (user) => `<div class="flex h-screen bg-background text-text-primary"><aside class="sidebar w-64 flex-shrink-0 flex flex-col border-r bg-sidebar-bg border-border-color"><div class="h-16 flex items-center justify-center px-4 border-b border-inherit"><h1 class="text-xl font-bold text-blue-500 flex items-center gap-2"><i class="fas fa-shield-alt"></i><span>PAINEL GCM</span></h1></div><nav class="flex-1 px-4 py-6 space-y-1.5" id="main-nav"><a href="#dashboard" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold hover:bg-gray-200 dark:hover:bg-gray-700">Dashboard</a><a href="#reports" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold hover:bg-gray-200 dark:hover:bg-gray-700">Relatórios</a><a href="#spreadsheet" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold hover:bg-gray-200 dark:hover:bg-gray-700">Planilha</a></nav><div class="p-4 border-t border-inherit"><a href="#settings" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 mb-2">Configurações</a></div></aside><main class="flex-1 flex flex-col overflow-hidden"><header class="h-16 flex items-center justify-between px-6 border-b border-inherit bg-card-bg/80 backdrop-blur-sm"><h2 id="page-title" class="text-2xl font-bold"></h2><div class="flex items-center space-x-4"><button id="theme-toggle" class="text-slate-500 w-10 h-10 flex items-center justify-center"></button><div class="text-right"><div class="font-semibold text-sm">${user.name}</div><div class="text-xs text-text-secondary">${user.email}</div></div></div></header><div id="page-content" class="flex-1 overflow-y-auto p-6 page-fade-in"></div></main></div>`,
                    loadingDashboard: () => `<div class="text-center p-16 text-text-secondary"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`,
                    dashboardPage: (s) => `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${this.templates.summaryCard("Total de Agentes", s.totalAgents, "fa-users")}</div><div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 card rounded-xl p-6 bg-card-bg"><h3 class="font-semibold mb-4 text-lg">Atividade da Semana</h3><div class="h-80"><canvas id="activity-chart"></canvas></div></div><div class="card rounded-xl p-6 bg-card-bg"><h3 class="font-semibold mb-4 text-lg">Atividade Recente</h3><ul id="activity-feed" class="space-y-4"></ul></div></div><div class="mt-6 card rounded-xl p-6 bg-card-bg"><h3 class="font-semibold mb-4 text-lg">Registros por Hora (Hoje)</h3><div class="h-80"><canvas id="hourly-activity-chart"></canvas></div></div>`,
                    activityFeedItem: (item) => `<li class="flex items-center text-sm"><i class="fas ${item.ponto.saida ? 'fa-sign-out-alt text-red-500' : 'fa-sign-in-alt text-green-500'} w-4 mr-3"></i><div><span class="font-semibold">${item.username}</span> ${item.ponto.saida ? 'encerrou' : 'iniciou'} o ponto.</div><span class="ml-auto text-xs text-text-secondary">${new Date(item.ponto.saida || item.ponto.entrada).toLocaleTimeString('pt-BR')}</span></li>`,
                    summaryCard: (t, v, i, c = '') => `<div class="card rounded-xl p-5 bg-card-bg"><div class="flex items-center"><div class="p-3 rounded-full bg-blue-500/10 text-blue-500 mr-4"><i class="fas ${i}"></i></div><div><h4 class="text-sm font-medium text-text-secondary">${t}</h4><p class="text-2xl font-bold mt-1 ${c}">${v}</p></div></div></div>`,
                    reportsPage: (users) => `...`,
                    spreadsheetPage: () => `...`,
                    settingsPage: () => `...`,
                    errorPage: (message) => `<div class="text-center p-16"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><h1 class="text-2xl font-bold">Ocorreu um Erro</h1><p class="text-text-secondary">${message}</p></div>`,
                    loadingRow: c => `...`,
                    emptyRow: c => `...`,
                    errorRow: c => `...`,
                    reportRow: p => `...`,
                    notFoundPage: () => `...`,
                };
            }
        }
        new GcmPanelApp(document.getElementById('app-root'));
    </script>
</body>
</html>